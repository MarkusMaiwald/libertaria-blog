---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('blog');
const now = new Date();
const publishedPosts = posts.filter(p => p.data.pubDate <= now);

// Build search index as JSON string
const searchData = publishedPosts.map(post => ({
  slug: post.slug,
  title: post.data.title,
  description: post.data.description,
  tags: post.data.tags || [],
  dateFormatted: post.data.pubDate.toLocaleDateString('en-us', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }),
  searchText: `${post.data.title} ${post.data.description} ${(post.data.tags || []).join(' ')}`.toLowerCase()
}));

const searchDataJson = JSON.stringify(searchData);

// Get all unique tags
const allTags = [...new Set(publishedPosts.flatMap(p => p.data.tags || []))].sort();
---

<Layout title="Search | Libertaria" description="Search all articles on sovereign infrastructure, protocols, and exits.">
  <section class="search-page">
    <h1>üîç Search</h1>
    
    <div class="search-box">
      <input 
        type="text" 
        id="search-input" 
        placeholder="Search articles, axioms, concepts..."
        autocomplete="off"
      />
    </div>
    
    <div id="search-stats" class="stats"></div>
    
    <div id="search-results" class="results">
      <p class="placeholder">Type to search {publishedPosts.length} articles...</p>
    </div>
    
    <div class="all-tags">
      <h3>Browse by tag:</h3>
      <div class="tags">
        {allTags.map(tag => (
          <button class="tag-btn" data-tag={tag}>#{tag}</button>
        ))}
      </div>
    </div>
  </section>
</Layout>

<script is:inline define:vars={{ searchDataJson }}>
  // Parse the search data
  const searchData = JSON.parse(searchDataJson);
  
  const input = document.getElementById('search-input');
  const resultsDiv = document.getElementById('search-results');
  const statsDiv = document.getElementById('search-stats');
  
  function search(query) {
    if (!query.trim()) {
      resultsDiv.innerHTML = `<p class="placeholder">Type to search ${searchData.length} articles...</p>`;
      statsDiv.textContent = '';
      return;
    }
    
    const q = query.toLowerCase().trim();
    const matches = searchData.filter(item => 
      item.searchText.includes(q) ||
      item.title.toLowerCase().includes(q) ||
      item.tags.some(t => t.toLowerCase().includes(q))
    );
    
    statsDiv.textContent = `${matches.length} result${matches.length !== 1 ? 's' : ''} for "${query}"`;
    
    if (matches.length === 0) {
      resultsDiv.innerHTML = '<p class="no-results">No results found.</p>';
      return;
    }
    
    resultsDiv.innerHTML = matches.map(item => `
      <article class="result-card">
        <a href="/blog/${item.slug}/">
          <h3>${highlight(item.title, q)}</h3>
          <p>${item.description}</p>
          <div class="meta">
            <time>${item.dateFormatted}</time>
            ${item.tags.map(t => `<span class="tag">#${t}</span>`).join('')}
          </div>
        </a>
      </article>
    `).join('');
  }
  
  function highlight(text, query) {
    const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
  }
  
  function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
  
  // Input handler with debounce
  let timer;
  input.addEventListener('input', (e) => {
    clearTimeout(timer);
    timer = setTimeout(() => search(e.target.value), 100);
  });
  
  // Tag buttons
  document.querySelectorAll('.tag-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tag = btn.dataset.tag;
      input.value = tag;
      search(tag);
    });
  });
  
  // Keyboard shortcut
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement !== input) {
      e.preventDefault();
      input.focus();
    }
  });
  
  // Focus on load
  input.focus();
</script>

<style>
  .search-page {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }
  
  h1 {
    font-size: 2.5rem;
    margin-bottom: 2rem;
    color: var(--accent);
    text-align: center;
  }
  
  .search-box {
    margin-bottom: 1.5rem;
  }
  
  #search-input {
    width: 100%;
    padding: 1rem 1.5rem;
    font-size: 1.2rem;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: var(--text);
    transition: border-color 0.2s;
  }
  
  #search-input:focus {
    outline: none;
    border-color: var(--accent);
  }
  
  .stats {
    color: var(--gray);
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }
  
  .placeholder, .no-results {
    text-align: center;
    color: var(--gray);
    padding: 3rem;
    font-style: italic;
  }
  
  .result-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    transition: all 0.2s;
  }
  
  .result-card:hover {
    transform: translateX(4px);
    border-color: var(--accent);
  }
  
  .result-card a {
    color: inherit;
    text-decoration: none;
  }
  
  .result-card h3 {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    color: var(--accent);
  }
  
  .result-card h3 mark {
    background: rgba(255, 184, 0, 0.3);
    color: var(--accent);
    padding: 0 2px;
    border-radius: 2px;
  }
  
  .result-card p {
    color: var(--gray);
    font-size: 0.95rem;
    margin-bottom: 0.75rem;
  }
  
  .meta {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    font-size: 0.8rem;
    color: var(--gray);
  }
  
  .tag {
    background: rgba(255, 184, 0, 0.15);
    color: var(--accent);
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
  }
  
  .all-tags {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding-top: 1.5rem;
    margin-top: 2rem;
  }
  
  .all-tags h3 {
    font-size: 0.9rem;
    color: var(--gray);
    margin-bottom: 0.75rem;
  }
  
  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .tag-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--text);
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .tag-btn:hover {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
  }
</style>
